  if(nfiles > 1) then !the following is meaningless for a single file
     dgf=0.
     dgfsum=0.
     sum=0.
     veff1=0.
     veff2=0.
     dv=0.
     
     ! loop over all the files
     do ifile=1,nfiles-1
        !check that number of points > number to skip
        if(nskip >= FEP(ifile)%npts) then
           write(*,999) ifile, nskip, FEP(ifile)%npts
999        format('File',i5,' contains only',i5,' points. Can''t skip',i5)
        end if
        
        ! nskip is points to skip (not sure what this is)
        do ipt=nskip+1,FEP(ifile)%npts
           ! states is for each lambda state, calculate veff's (what are those?)
           do istate=1,nstates
              veff1=veff1                        ! this is: EQ(:)%lambda
                    +FEP(ifile)%lambda(istate) * FEP(ifile)%v(istate,ipt) (lambda * potential of state at timepoint)
              
              
              ! veff2 = the next state (which is the next file here)
              veff2=veff2
                   +FEP(ifile+1)%lambda(istate)*FEP(ifile)%v(istate,ipt)
           end do
           dv=veff2-veff1
           veff1=0.
           veff2=0.
           !dv, rt = 1/beta
           sum=sum+exp(-dv/rt) (rt = kT)
        end do
        
        !get average of the energies
        sum=sum/real(FEP(ifile)%npts-nskip)
        
        ! Calculates DG
        dgf(ifile)=-rt*dlog(sum)
        
        ! keep track of sum of energies
        dgfsum(ifile+1)=dgfsum(ifile)+dgf(ifile)
        sum=0.
     end do